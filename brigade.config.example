# Brigade Configuration
# Copy this to your project's brigade/ directory and customize
#
# NOTE: This file is OPTIONAL. Brigade works out of the box with just Claude CLI.
# Use this file to customize workers, enable OpenCode for cost savings, etc.

# ═══════════════════════════════════════════════════════════════════════════════
# QUICK START - COST OPTIMIZATION
# ═══════════════════════════════════════════════════════════════════════════════
# Two settings for cost savings with OpenCode:

USE_OPENCODE=false  # Set to true to use OpenCode for junior tasks

# Pick your OpenCode model (only used if USE_OPENCODE=true):
# Run `opencode models` to see all available models
OPENCODE_MODEL="zai-coding-plan/glm-4.7"  # Default: GLM 4.7 (fast, cheap)

# Other model options - just change the line above:
#   zai-coding-plan/glm-4.7                   - GLM 4.7 (default, fast)
#   opencode/glm-4.7-free                     - GLM 4.7 free tier
#   anthropic/claude-3-5-sonnet-latest        - Claude Sonnet via OpenCode
#   anthropic/claude-sonnet-4-5               - Claude Sonnet 4.5 via OpenCode

# ═══════════════════════════════════════════════════════════════════════════════
# WORKERS (Advanced - most people don't need to change these)
# ═══════════════════════════════════════════════════════════════════════════════
# Brigade supports multiple AI coding agents. Configure based on what you have.
#
# Supported agents:
#   claude      - Anthropic Claude (via claude CLI) - DEFAULT
#   opencode    - OpenCode (via opencode CLI) - recommended for junior tasks
#   codex       - OpenAI Codex (coming soon)
#   gemini      - Google Gemini (coming soon)
#   aider       - Aider (coming soon)
#   cursor      - Cursor (coming soon)
#   local       - Local models via Ollama (coming soon)
#
# DEFAULT: All workers use Claude. This works if you only have claude CLI installed.
# For cost savings, configure OpenCode for Line Cook (junior tasks).
#
# ═══════════════════════════════════════════════════════════════════════════════

# Executive Chef (director) - analyzes tasks, reviews work
# Recommended: Claude Opus for best reasoning
EXECUTIVE_CMD="claude --model opus"
EXECUTIVE_AGENT="claude"

# Sous Chef (senior) - complex tasks, architecture, integration
# Recommended: Claude Sonnet for balance of capability and cost
SOUS_CMD="claude --model sonnet"
SOUS_AGENT="claude"

# Line Cook (junior) - routine tasks, boilerplate, simple tests
# Default: Claude Sonnet (works out of the box)
# For cost savings: Set USE_OPENCODE=true above (recommended) or customize here
LINE_CMD="claude --model sonnet"
LINE_AGENT="claude"

# ═══════════════════════════════════════════════════════════════════════════════
# OPENCODE SETTINGS (Advanced)
# ═══════════════════════════════════════════════════════════════════════════════

# IMPORTANT: OpenCode must be configured to auto-approve permissions.
# Add this to ~/.config/opencode/opencode.json:
#   {
#     "permission": "allow"
#   }
# Without this, OpenCode will prompt for approval and hang in non-interactive mode.

# Optional: OpenCode server for faster cold starts
# OPENCODE_SERVER="http://localhost:4096"

# Claude settings
CLAUDE_DANGEROUSLY_SKIP_PERMISSIONS=true  # Auto-approve in non-interactive mode

# Codex settings (coming soon)
# CODEX_API_KEY=""
# CODEX_MODEL="code-davinci-002"

# Gemini settings (coming soon)
# GEMINI_API_KEY=""
# GEMINI_MODEL="gemini-pro"

# Aider settings (coming soon)
# AIDER_MODEL="gpt-4"

# Local/Ollama settings (coming soon)
# OLLAMA_MODEL="codellama"
# OLLAMA_HOST="http://localhost:11434"

# ═══════════════════════════════════════════════════════════════════════════════
# OUTPUT
# ═══════════════════════════════════════════════════════════════════════════════

# Suppress worker conversation output (still captured to file for review)
# When enabled, shows animated spinner instead of full conversation:
#   ⠋ US-003: Add user validation (2m 45s)
# Useful for cleaner logs when running unattended or monitoring multiple tasks
QUIET_WORKERS=false

# ═══════════════════════════════════════════════════════════════════════════════
# VISIBILITY & MONITORING
# ═══════════════════════════════════════════════════════════════════════════════

# Activity heartbeat log - periodic status written to a tail-able file
# Set path to enable (relative to project root or absolute)
# Example: tail -f brigade/tasks/activity.log
ACTIVITY_LOG=""  # e.g., "brigade/tasks/activity.log"
ACTIVITY_LOG_INTERVAL=30  # Seconds between heartbeat writes

# Task timeout warnings - alert when tasks exceed expected duration
# Set to 0 to disable warnings for that complexity level
TASK_TIMEOUT_WARNING_JUNIOR=10  # Minutes before warning for junior tasks
TASK_TIMEOUT_WARNING_SENIOR=20  # Minutes before warning for senior tasks

# Worker output logging - stream all worker output to per-task log files
# Set directory to enable (creates: {prd-prefix}-{task-id}-{worker}-{timestamp}.log)
# Useful for debugging and post-mortems
WORKER_LOG_DIR=""  # e.g., "brigade/logs/"

# Status watch mode refresh interval
STATUS_WATCH_INTERVAL=30  # Seconds between refreshes in `status --watch` mode

# ═══════════════════════════════════════════════════════════════════════════════
# SUPERVISOR INTEGRATION
# ═══════════════════════════════════════════════════════════════════════════════
# For AI supervisors (Claude, TUI tools, etc.) to monitor Brigade with minimal overhead.
# All file-based - no webhooks or network connections required.

# Compact status JSON written on every state change
# Supervisor reads this file instead of polling `./brigade.sh status --brief`
# Format: {"done":3,"total":13,"current":"US-004","worker":"sous","elapsed":125,"attention":false}
SUPERVISOR_STATUS_FILE=""  # e.g., "brigade/tasks/status.json"

# Append-only JSONL event stream for real-time monitoring
# Supervisor tails this file to receive events as they happen
# Events: service_start, task_start, task_complete, escalation, review, attention, service_complete
SUPERVISOR_EVENTS_FILE=""  # e.g., "brigade/tasks/events.jsonl"

# ═══════════════════════════════════════════════════════════════════════════════
# CODEBASE MAP
# ═══════════════════════════════════════════════════════════════════════════════

# Regenerate codebase map if this many commits behind HEAD during planning
# Set to 0 to disable staleness checking
MAP_STALE_COMMITS=20

# ═══════════════════════════════════════════════════════════════════════════════
# GIT
# ═══════════════════════════════════════════════════════════════════════════════

# Default branch for merging (leave empty to auto-detect from origin)
# Auto-detection checks: git symbolic-ref refs/remotes/origin/HEAD
# Common values: main, master, develop
DEFAULT_BRANCH=""

# ═══════════════════════════════════════════════════════════════════════════════
# TESTING
# ═══════════════════════════════════════════════════════════════════════════════

# Command to run after each task to verify completion
# Leave empty to skip testing
TEST_CMD=""

# Examples:
# TEST_CMD="go test ./..."
# TEST_CMD="npm test"
# TEST_CMD="pytest"
# TEST_CMD="cargo test"

# Timeout for test execution in seconds
# Tests exceeding this are flagged as "hung" (likely spawning interactive processes)
TEST_TIMEOUT=120

# ═══════════════════════════════════════════════════════════════════════════════
# VERIFICATION
# ═══════════════════════════════════════════════════════════════════════════════

# Enable verification commands (run after worker signals COMPLETE)
# When enabled, tasks with a "verification" array have those commands run
# All must pass (exit 0) for task to be marked complete
VERIFICATION_ENABLED=true

# Timeout per verification command in seconds
VERIFICATION_TIMEOUT=60

# Scan changed files for TODO/FIXME/HACK markers before marking complete
# When enabled, tasks with incomplete markers must address them before completion
TODO_SCAN_ENABLED=true

# Warn at service start if PRD only has grep-based verification (no execution tests)
# Grep-only verification lets broken implementations pass
VERIFICATION_WARN_GREP_ONLY=true

# ═══════════════════════════════════════════════════════════════════════════════
# ESCALATION
# ═══════════════════════════════════════════════════════════════════════════════

# Enable automatic escalation (Line Cook → Sous Chef after failures)
ESCALATION_ENABLED=true

# Number of iterations before escalating Line Cook → Sous Chef
ESCALATION_AFTER=3

# Enable Sous Chef → Executive Chef escalation (rare, for truly stuck tasks)
ESCALATION_TO_EXEC=true

# Number of iterations before escalating Sous Chef → Executive Chef
ESCALATION_TO_EXEC_AFTER=5

# ═══════════════════════════════════════════════════════════════════════════════
# TASK TIMEOUTS (Per-Complexity)
# ═══════════════════════════════════════════════════════════════════════════════
# Auto-escalate tasks that exceed timeout (independent of TEST_TIMEOUT)
# Set to 0 to disable timeout for that complexity level

# Junior/Line Cook tasks - simpler work, should complete faster
TASK_TIMEOUT_JUNIOR=900    # 15 minutes

# Senior/Sous Chef tasks - more complex, need more time
TASK_TIMEOUT_SENIOR=1800   # 30 minutes

# Executive Chef tasks - rare escalations, allow more time
TASK_TIMEOUT_EXECUTIVE=3600  # 60 minutes

# ═══════════════════════════════════════════════════════════════════════════════
# EXECUTIVE REVIEW
# ═══════════════════════════════════════════════════════════════════════════════

# Enable Executive Chef review after task completion
REVIEW_ENABLED=true

# Only review tasks completed by junior workers (saves Opus calls)
REVIEW_JUNIOR_ONLY=true

# ═══════════════════════════════════════════════════════════════════════════════
# PHASE REVIEW (Optional - for larger projects)
# ═══════════════════════════════════════════════════════════════════════════════

# Enable periodic phase reviews where Executive Chef checks overall progress
# Useful for larger PRDs (10+ tasks) to catch drift from spec early
PHASE_REVIEW_ENABLED=false

# Review every N completed tasks (e.g., 5 = review after task 5, 10, 15...)
PHASE_REVIEW_AFTER=5

# Action to take when phase review finds issues:
#   continue  - Log concerns and continue (default)
#   pause     - Stop execution, require manual restart
#   remediate - Let Executive Chef add corrective tasks to PRD
PHASE_REVIEW_ACTION=continue

# ═══════════════════════════════════════════════════════════════════════════════
# CONTEXT ISOLATION
# ═══════════════════════════════════════════════════════════════════════════════

# Enable context isolation (fresh sessions per task)
CONTEXT_ISOLATION=true

# State file for session persistence (relative to PRD directory)
STATE_FILE="brigade-state.json"

# ═══════════════════════════════════════════════════════════════════════════════
# KNOWLEDGE SHARING
# ═══════════════════════════════════════════════════════════════════════════════

# Enable knowledge sharing between workers
KNOWLEDGE_SHARING=true

# Learnings file (relative to PRD directory)
LEARNINGS_FILE="brigade-learnings.md"

# Backlog file for out-of-scope discoveries (relative to PRD directory)
# Workers can log items with: <backlog>Description</backlog>
BACKLOG_FILE="brigade-backlog.md"

# Maximum learnings per file (0 = unlimited)
# When exceeded, oldest learnings are pruned
LEARNINGS_MAX=50

# Archive learnings to {prd-dir}/archive/ on PRD completion
LEARNINGS_ARCHIVE=true

# ═══════════════════════════════════════════════════════════════════════════════
# PARALLEL EXECUTION
# ═══════════════════════════════════════════════════════════════════════════════

# Maximum parallel workers (0 = sequential)
MAX_PARALLEL=3

# ═══════════════════════════════════════════════════════════════════════════════
# AUTO-CONTINUE (Multi-PRD Chaining)
# ═══════════════════════════════════════════════════════════════════════════════

# Enable auto-continue mode for chaining multiple PRDs
# Use with: ./brigade.sh --auto-continue service brigade/tasks/prd-*.json
AUTO_CONTINUE=false

# Phase gate behavior between PRDs:
#   continue  - Proceed immediately to next PRD (default)
#   pause     - Stop after each PRD, require manual restart
#   review    - Executive Chef reviews before proceeding to next PRD
PHASE_GATE="continue"

# ═══════════════════════════════════════════════════════════════════════════════
# WALKAWAY MODE (Autonomous Execution)
# ═══════════════════════════════════════════════════════════════════════════════
# Full autonomous execution with AI-driven resume decisions.
# When enabled, Executive Chef decides retry/skip on failures instead of prompting.
# Also auto-enabled when PRD has "walkaway": true

# Enable walkaway mode (AI decides retry/skip on failures)
# Use with: ./brigade.sh --walkaway service prd.json
WALKAWAY_MODE=false

# Safety rail: max consecutive skips before pausing
# Prevents runaway skipping when tasks are fundamentally broken
WALKAWAY_MAX_SKIPS=3

# Timeout for AI decision in seconds
WALKAWAY_DECISION_TIMEOUT=120

# ═══════════════════════════════════════════════════════════════════════════════
# LIMITS
# ═══════════════════════════════════════════════════════════════════════════════

# Maximum iterations per task before giving up
MAX_ITERATIONS=50
